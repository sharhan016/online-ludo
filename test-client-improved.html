<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ludo Game Test Client - Improved</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { color: #333; margin: 0 0 10px 0; }
    h2 { color: #666; margin-top: 0; font-size: 18px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .connected { background: #d4edda; color: #155724; }
    .disconnected { background: #f8d7da; color: #721c24; }
    .game-info {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .game-info div { margin: 5px 0; }
    .game-info strong { color: #007bff; min-width: 120px; display: inline-block; }
    .btn-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s;
      flex: 1;
      min-width: 150px;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-warning { background: #ffc107; color: #000; }
    .btn-warning:hover { background: #e0a800; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
      margin-bottom: 10px;
    }
    .dice-display {
      font-size: 48px;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      margin: 15px 0;
    }
    .tokens-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .token-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .token-card:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .token-card.selected { border-color: #007bff; background: #e7f3ff; }
    .token-card.disabled { opacity: 0.5; cursor: not-allowed; }
    .token-card.disabled:hover { transform: none; }
    .token-card.blue { border-left: 4px solid #0D92F4; }
    .token-card.green { border-left: 4px solid #41B06E; }
    .token-card.red { border-left: 4px solid #FF5B5B; }
    .token-card.yellow { border-left: 4px solid #FFD966; }
    .token-id { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
    .token-pos { color: #666; font-size: 14px; }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 6px;
      padding: 3px;
      border-left: 3px solid #007bff;
      padding-left: 8px;
    }
    .log-entry.error { border-color: #dc3545; color: #ff6b6b; }
    .log-entry.success { border-color: #28a745; color: #51cf66; }
    .log-entry.info { border-color: #17a2b8; color: #4dabf7; }
    .log-entry.warning { border-color: #ffc107; color: #ffd43b; }
    .alert {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #007bff;
      background: #e7f3ff;
      font-size: 14px;
    }
    .alert-warning { border-color: #ffc107; background: #fff3cd; }
    .alert-success { border-color: #28a745; background: #d4edda; }
    .phase-indicator {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .phase-rolling { background: #ffc107; color: #000; }
    .phase-moving { background: #28a745; color: white; }
    .phase-waiting { background: #6c757d; color: white; }
  </style>
</head>
<body>
  <h1>üé≤ Ludo Game Test Client (Improved)</h1>

  <div class="grid">
    <!-- Left Column -->
    <div>
      <div class="container">
        <h2>Connection & Room</h2>
        <div id="status" class="status disconnected">Disconnected</div>
        
        <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="Server URL">
        <input type="text" id="playerName" placeholder="Your Name (auto-generated)">
        <input type="text" id="roomCode" placeholder="Room Code (to join)">
        
        <div class="btn-group">
          <button id="connectBtn" class="btn-primary" onclick="connect()">Connect</button>
          <button class="btn-success" onclick="createRoom()">Create Room</button>
          <button class="btn-warning" onclick="joinRoom()">Join Room</button>
          <button class="btn-danger" onclick="startGame()">Start Game</button>
        </div>
      </div>

      <div class="container">
        <h2>Game State</h2>
        <div id="gameInfo" class="game-info" style="display: none;">
          <div><strong>Room:</strong> <span id="currentRoom">-</span></div>
          <div><strong>Players:</strong> <span id="playerCount">0</span></div>
          <div><strong>Your Color:</strong> <span id="yourColor">-</span></div>
          <div><strong>Current Turn:</strong> <span id="currentTurn">-</span></div>
          <div><strong>Phase:</strong> <span id="gamePhase" class="phase-indicator phase-waiting">Waiting</span></div>
        </div>

        <div id="diceDisplay" class="dice-display" style="display: none;">
          üé≤ <span id="diceValue">-</span>
        </div>

        <div class="btn-group">
          <button class="btn-success" onclick="rollDice()" style="font-size: 18px;">üé≤ Roll Dice</button>
        </div>
      </div>

      <div class="container">
        <h2>Event Log</h2>
        <div id="log" class="log"></div>
        <button class="btn-danger" onclick="clearLog()" style="margin-top: 10px; width: 100%;">Clear Log</button>
      </div>
    </div>

    <!-- Right Column -->
    <div>
      <div class="container">
        <h2>Your Tokens</h2>
        <div id="tokenAlert" class="alert" style="display: none;"></div>
        <div id="tokensGrid" class="tokens-grid">
          <p style="color: #666;">Connect and start a game to see your tokens</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket = null;
    let currentRoomCode = null;
    let currentPlayerId = null;
    let currentPlayerColor = null;
    let gameState = null;
    let selectedToken = null;
    let lastDiceValue = null;

    function generateId() {
      return 'player-' + Math.random().toString(36).substr(2, 9);
    }

    function generateName() {
      const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry'];
      return names[Math.floor(Math.random() * names.length)];
    }

    window.onload = () => {
      document.getElementById('playerName').value = generateName();
      log('Ready to test! Open this page in TWO tabs.', 'info');
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function updateStatus(connected) {
      const statusDiv = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      
      if (connected) {
        statusDiv.textContent = `‚úÖ Connected (${socket.id})`;
        statusDiv.className = 'status connected';
        connectBtn.textContent = 'Disconnect';
        connectBtn.onclick = disconnect;
      } else {
        statusDiv.textContent = '‚ùå Disconnected';
        statusDiv.className = 'status disconnected';
        connectBtn.textContent = 'Connect';
        connectBtn.onclick = connect;
      }
    }

    function updateGameInfo() {
      if (!gameState) return;
      
      const gameInfo = document.getElementById('gameInfo');
      gameInfo.style.display = 'block';
      
      document.getElementById('currentRoom').textContent = currentRoomCode || '-';
      document.getElementById('playerCount').textContent = gameState.players.length;
      
      const myPlayer = gameState.players.find(p => p.playerId === currentPlayerId);
      if (myPlayer) {
        currentPlayerColor = myPlayer.color;
        document.getElementById('yourColor').textContent = myPlayer.color;
      }
      
      const currentPlayer = gameState.players[gameState.currentPlayerIndex];
      const isMyTurn = currentPlayer.playerId === currentPlayerId;
      document.getElementById('currentTurn').textContent = 
        isMyTurn ? 'üéØ YOUR TURN!' : `${currentPlayer.playerName} (${currentPlayer.color})`;
      
      const phaseSpan = document.getElementById('gamePhase');
      phaseSpan.textContent = gameState.phase;
      phaseSpan.className = `phase-indicator phase-${gameState.phase}`;
      
      if (gameState.diceValue) {
        document.getElementById('diceDisplay').style.display = 'block';
        document.getElementById('diceValue').textContent = gameState.diceValue;
        lastDiceValue = gameState.diceValue;
      }
      
      renderTokens();
    }

    function renderTokens() {
      if (!gameState || !currentPlayerColor) return;
      
      const tokensGrid = document.getElementById('tokensGrid');
      const tokenAlert = document.getElementById('tokenAlert');
      const myTokens = gameState.tokenPositions[currentPlayerColor] || [];
      const currentPlayer = gameState.players[gameState.currentPlayerIndex];
      const isMyTurn = currentPlayer.playerId === currentPlayerId;
      const canMove = isMyTurn && gameState.phase === 'moving' && lastDiceValue;
      
      if (canMove) {
        tokenAlert.style.display = 'block';
        tokenAlert.className = 'alert alert-success';
        tokenAlert.textContent = `üéØ You rolled a ${lastDiceValue}! Click a token to move it.`;
      } else if (isMyTurn && gameState.phase === 'rolling') {
        tokenAlert.style.display = 'block';
        tokenAlert.className = 'alert alert-warning';
        tokenAlert.textContent = 'üé≤ Roll the dice to continue!';
      } else {
        tokenAlert.style.display = 'none';
      }
      
      tokensGrid.innerHTML = '';
      
      myTokens.forEach(token => {
        const card = document.createElement('div');
        card.className = `token-card ${currentPlayerColor.toLowerCase()}`;
        
        if (canMove) {
          card.onclick = () => selectToken(token);
          if (selectedToken && selectedToken.tokenId === token.tokenId) {
            card.classList.add('selected');
          }
        } else {
          card.classList.add('disabled');
        }
        
        const isInBase = token.positionId.length === 2 && !token.positionId.endsWith('F');
        const isInHome = token.positionId.endsWith('F');
        
        let status = 'üìç On Board';
        if (isInBase) status = 'üè† In Base';
        if (isInHome) status = 'üèÅ Finished';
        
        card.innerHTML = `
          <div class="token-id">${token.tokenId}</div>
          <div class="token-pos">${status}</div>
          <div class="token-pos">Position: ${token.positionId}</div>
        `;
        
        tokensGrid.appendChild(card);
      });
    }

    function selectToken(token) {
      selectedToken = token;
      renderTokens();
      
      // Auto-move the token
      moveToken(token);
    }

    function connect() {
      const serverUrl = document.getElementById('serverUrl').value;
      currentPlayerId = generateId();
      
      socket = io(serverUrl, {
        transports: ['websocket', 'polling'],
      });

      socket.on('connect', () => {
        log('‚úÖ Connected to server', 'success');
        updateStatus(true);
      });

      socket.on('disconnect', () => {
        log('‚ùå Disconnected', 'error');
        updateStatus(false);
      });

      socket.on('error', (error) => {
        log(`‚ùå Error: ${error.message}`, 'error');
      });

      socket.on('room_created', (data) => {
        currentRoomCode = data.room.roomCode;
        document.getElementById('roomCode').value = currentRoomCode;
        log(`üè† Room created: ${currentRoomCode}`, 'success');
        log(`üìã Share code with Player 2: ${currentRoomCode}`, 'warning');
      });

      socket.on('player_joined', (data) => {
        log(`üë§ ${data.player.playerName} joined (${data.room.players.length} players)`, 'success');
      });

      socket.on('ready_to_start', (data) => {
        log(`‚úÖ ${data.room.players.length} players ready! Host can start the game.`, 'success');
      });

      socket.on('game_started', (data) => {
        gameState = data.gameState;
        log(`üéÆ Game started!`, 'success');
        updateGameInfo();
      });

      socket.on('dice_rolled', (data) => {
        lastDiceValue = data.diceValue;
        log(`üé≤ Dice: ${data.diceValue}`, 'info');
        if (data.skipTurn) {
          if (data.diceValue === 6 && data.diceValue === 6) {
            log(`‚ö†Ô∏è Three consecutive 6s! Turn skipped.`, 'warning');
          } else {
            log(`‚è≠Ô∏è No valid moves! Turn skipped automatically.`, 'warning');
          }
        } else if (data.diceValue === 6) {
          log(`üéâ Rolled a 6! Extra turn or move from base`, 'success');
        }
      });

      socket.on('token_moved', (data) => {
        log(`üéØ ${data.tokenId}: ${data.fromPosition} ‚Üí ${data.toPosition}`, 'success');
        if (data.capturedTokenId) {
          log(`üí• Captured: ${data.capturedTokenId}`, 'warning');
        }
        selectedToken = null;
        lastDiceValue = null;
      });

      socket.on('game_state_update', (data) => {
        gameState = data;
        updateGameInfo();
      });
    }

    function disconnect() {
      if (socket) {
        socket.close();
        socket = null;
        updateStatus(false);
      }
    }

    function createRoom() {
      if (!socket) return log('‚ùå Not connected', 'error');
      
      const playerName = document.getElementById('playerName').value || generateName();
      socket.emit('create_room', {
        playerId: currentPlayerId,
        playerName,
        preferredPlayers: 2,
      });
      log(`üì§ Creating room as ${playerName}...`, 'info');
    }

    function joinRoom() {
      if (!socket) return log('‚ùå Not connected', 'error');
      
      const roomCode = document.getElementById('roomCode').value;
      if (!roomCode) return log('‚ùå Enter room code', 'error');
      
      const playerName = document.getElementById('playerName').value || generateName();
      currentRoomCode = roomCode;
      
      socket.emit('join_room', {
        roomCode,
        playerId: currentPlayerId,
        playerName,
      });
      log(`üì§ Joining ${roomCode} as ${playerName}...`, 'info');
    }

    function startGame() {
      if (!socket || !currentRoomCode) return log('‚ùå Create/join room first', 'error');
      
      socket.emit('start_game', {
        roomCode: currentRoomCode,
        playerId: currentPlayerId,
      });
      log(`üì§ Starting game...`, 'info');
    }

    function rollDice() {
      if (!socket || !currentRoomCode) return log('‚ùå No active game', 'error');
      
      socket.emit('roll_dice', {
        roomCode: currentRoomCode,
        playerId: currentPlayerId,
      });
      log(`üì§ Rolling dice...`, 'info');
    }

    function moveToken(token) {
      if (!socket || !currentRoomCode || !lastDiceValue) return;
      
      // Calculate target position based on current position and dice value
      const targetPosition = calculateTargetPosition(token.positionId, lastDiceValue, currentPlayerColor);
      
      if (!targetPosition) {
        log(`‚ùå Cannot move ${token.tokenId}`, 'error');
        return;
      }
      
      socket.emit('move_token', {
        roomCode: currentRoomCode,
        playerId: currentPlayerId,
        tokenId: token.tokenId,
        targetPositionId: targetPosition,
      });
      log(`üì§ Moving ${token.tokenId} to ${targetPosition}...`, 'info');
    }

    function calculateTargetPosition(currentPos, diceValue, color) {
      // If in base and rolled 6, move to start position
      const isInBase = currentPos.length === 2 && !currentPos.endsWith('F');
      if (isInBase && diceValue === 6) {
        const startPositions = {
          'blue': 'B04',
          'green': 'G21',
          'red': 'R10',
          'yellow': 'Y42'
        };
        return startPositions[color.toLowerCase()];
      }
      
      // If in base but didn't roll 6, can't move
      if (isInBase) {
        return null;
      }
      
      // Get the path for this color
      const paths = {
        'blue': ['B04', 'B03', 'B02', 'B01', 'B00', 'R52', 'R42', 'R32', 'R22', 'R12', 'R02', 'R01', 'R00', 'R10', 'R20', 'R30', 'R40', 'R50', 'G05', 'G04', 'G03', 'G02', 'G01', 'G00', 'G10', 'G20', 'G21', 'G22', 'G23', 'G24', 'G25', 'Y00', 'Y10', 'Y20', 'Y30', 'Y40', 'Y50', 'Y51', 'Y52', 'Y42', 'Y32', 'Y22', 'Y12', 'Y02', 'B20', 'B21', 'B22', 'B23', 'B24', 'B25', 'B15', 'B14', 'B13', 'B12', 'B11', 'B10', 'BF'],
        'green': ['G21', 'G22', 'G23', 'G24', 'G25', 'Y00', 'Y10', 'Y20', 'Y30', 'Y40', 'Y50', 'Y51', 'Y52', 'Y42', 'Y32', 'Y22', 'Y12', 'Y02', 'B20', 'B21', 'B22', 'B23', 'B24', 'B25', 'B15', 'B05', 'B04', 'B03', 'B02', 'B01', 'B00', 'R52', 'R42', 'R32', 'R22', 'R12', 'R02', 'R01', 'R00', 'R10', 'R20', 'R30', 'R40', 'R50', 'G05', 'G04', 'G03', 'G02', 'G01', 'G00', 'G10', 'G11', 'G12', 'G13', 'G14', 'G15', 'GF'],
        'red': ['R10', 'R20', 'R30', 'R40', 'R50', 'G05', 'G04', 'G03', 'G02', 'G01', 'G00', 'G10', 'G20', 'G21', 'G22', 'G23', 'G24', 'G25', 'Y00', 'Y10', 'Y20', 'Y30', 'Y40', 'Y50', 'Y51', 'Y52', 'Y42', 'Y32', 'Y22', 'Y12', 'Y02', 'B20', 'B21', 'B22', 'B23', 'B24', 'B25', 'B15', 'B05', 'B04', 'B03', 'B02', 'B01', 'B00', 'R52', 'R42', 'R32', 'R22', 'R12', 'R02', 'R01', 'R11', 'R21', 'R31', 'R41', 'R51', 'RF'],
        'yellow': ['Y42', 'Y32', 'Y22', 'Y12', 'Y02', 'B20', 'B21', 'B22', 'B23', 'B24', 'B25', 'B15', 'B05', 'B04', 'B03', 'B02', 'B01', 'B00', 'R52', 'R42', 'R32', 'R22', 'R12', 'R02', 'R01', 'R00', 'R10', 'R20', 'R30', 'R40', 'R50', 'G05', 'G04', 'G03', 'G02', 'G01', 'G00', 'G10', 'G20', 'G21', 'G22', 'G23', 'G24', 'G25', 'Y00', 'Y10', 'Y20', 'Y30', 'Y40', 'Y50', 'Y51', 'Y41', 'Y31', 'Y21', 'Y11', 'Y01', 'YF']
      };
      
      const path = paths[color.toLowerCase()];
      if (!path) return null;
      
      const currentIndex = path.indexOf(currentPos);
      if (currentIndex === -1) return null;
      
      const targetIndex = currentIndex + diceValue;
      if (targetIndex >= path.length) return null; // Would exceed path
      
      return path[targetIndex];
    }
  </script>
</body>
</html>
